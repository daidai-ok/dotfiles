# =============================================================================
# tmux 設定ファイル
# Claude Code並列セッション向けに最適化
# 環境: macOS / US配列 / Ghostty / prefix: Ctrl-a
# =============================================================================
#
# 使い方:
#   このファイルを ~/.tmux.conf にコピーして使う:
#     cp ~/dotfiles/tmux/tmux.conf ~/.tmux.conf
#   tmux起動時に自動で読み込まれる。
#   変更後は prefix + r で再読み込みできる（tmux再起動不要）。
#
# prefixキーとは:
#   tmuxの操作は「prefix を押して離す → キーを押す」の2段階で行う。
#   この設定では prefix = Ctrl+a。
#   例: ペインを左右に分割 → Ctrl+a を押して離す → v を押す
#
# Claude Code並列運用の典型的な流れ:
#   1. ターミナルでtmuxを起動:         tmux
#   2. Claude Code用セッションを作成:   prefix + C（自動で claude-1 と命名）
#   3. レイアウトを設定:               prefix + Option+1（2ペイン横並び）
#   4. 各ペインでClaude Codeを起動:     claude
#   5. 別のセッションを作成:            prefix + C（自動で claude-2 と命名）
#   6. セッション間を切り替え:          prefix + f（fzfで選択）
#   7. 直前のセッションに戻る:          prefix + Tab
#
# ┌─────────────────────────────────────────────────────────────────────┐
# │ キーバインド早見表（prefix = Ctrl-a を先に押してからキーを押す）    │
# ├─────────────────────────────────────────────────────────────────────┤
# │ ■ ペイン分割・移動（基本操作）                                     │
# │   prefix → v or |   横に分割                                      │
# │   prefix → -        縦に分割                                      │
# │   prefix → h/j/k/l  ペイン移動（Vim風: 左/下/上/右）              │
# │   prefix → 矢印キー ペイン移動                                    │
# │   prefix → z        ペインのズーム（全画面化/戻す）                │
# │   prefix → x        ペインを閉じる                                │
# │                                                                     │
# │ ■ ペインリサイズ                                                   │
# │   prefix → H/J/K/L  左/下/上/右に5セル拡大（連打可能）            │
# │                                                                     │
# │ ■ セッション管理（Claude Code並列実行の要）                        │
# │   prefix → C        claude-N セッションを自動作成                  │
# │   prefix → s        セッション一覧（tmuxデフォルト）               │
# │   prefix → S        セッション名を入力して切り替え                 │
# │   prefix → f        fzfでセッション選択（ポップアップ）            │
# │   prefix → Tab      直前のセッションに戻る                        │
# │   prefix → (/)      前/次のセッション                              │
# │   prefix → N        セッション名をclaude-Nにリネーム               │
# │   prefix → $        セッション名を変更（tmuxデフォルト）           │
# │                                                                     │
# │ ■ レイアウトプリセット（Option+数字）                              │
# │   prefix → Option+1   2ペイン横並び                                │
# │   prefix → Option+2   3ペイン（メイン+右上下）                     │
# │   prefix → Option+3   4ペイン均等タイル                            │
# │   prefix → Option+4   全ペイン横並び均等                           │
# │   prefix → Option+5   全ペイン縦並び均等                           │
# │   prefix → E          タイル状に再整列                             │
# │                                                                     │
# │ ■ 便利機能                                                         │
# │   prefix → y        全ペイン同時入力 ON/OFF                        │
# │   prefix → g        ポップアップシェル（Escで閉じる）              │
# │   prefix → m/M      ペインをマーク / マークしたペインと入れ替え    │
# │   prefix → B        ペインを別ウィンドウに分離                     │
# │   prefix → @        他ウィンドウのペインを結合                     │
# │                                                                     │
# │ ■ ウィンドウ                                                       │
# │   prefix → c        新規ウィンドウ                                 │
# │   prefix → n/p      次/前のウィンドウ                              │
# │   prefix → 1〜9     ウィンドウ番号で移動                           │
# │                                                                     │
# │ ■ コピーモード（prefix → [ で開始、vi操作）                        │
# │   v: 選択開始   y: コピー（クリップボードへ）  q: 終了             │
# │                                                                     │
# │ ■ その他                                                           │
# │   prefix → r        設定ファイルを再読み込み                       │
# │   prefix → ?        全キーバインド一覧（tmuxデフォルト）           │
# └─────────────────────────────────────────────────────────────────────┘

# =============================================================================
# 基本設定
# =============================================================================

# マウスでペイン選択・リサイズ・スクロールができるようにする
set -g mouse on

# ターミナルからのクリップボードアクセスを有効化
set -g set-clipboard on

# prefixキーを Ctrl+a に変更（デフォルトは Ctrl+b）
# Ctrl+a は左手小指で押しやすい位置にある
unbind C-b
set -g prefix C-a
# tmux内のアプリに Ctrl+a を送りたいときは Ctrl+a を2回押す
bind C-a send-prefix

# Ghosttyと連携するためのカラー設定（トゥルーカラー表示に必要）
set -g default-terminal "tmux-256color"
set -as terminal-features "xterm-ghostty:RGB"

# ウィンドウとペインの番号を1から開始する（0始まりだとキーボードの配置と合わない）
set -g base-index 1
setw -g pane-base-index 1

# ウィンドウを閉じたとき、残りのウィンドウ番号を詰め直す（歯抜けにならない）
set -g renumber-windows on

# ステータスバーを画面上部に表示する（下部だとコマンド入力と近くて見づらいため）
set -g status-position top
set -g status-interval 1

# =============================================================================
# ペイン分割・移動
# =============================================================================

# 画面を左右に分割する（vはvertical lineのイメージ、|は見た目そのまま）
# 分割後のペインは今いるディレクトリを引き継ぐ
bind v split-window -h -c "#{pane_current_path}"
bind | split-window -h -c "#{pane_current_path}"

# 画面を上下に分割する（-は横線のイメージ）
bind - split-window -v -c "#{pane_current_path}"

# 矢印キーでペイン間を移動する
bind Left select-pane -L
bind Down select-pane -D
bind Up select-pane -U
bind Right select-pane -R

# Vim風キーでもペイン間を移動できる（h=左, j=下, k=上, l=右）
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# ペインのサイズを変更する（大文字 H/J/K/L で5セルずつ）
# -r フラグにより、prefixを1回押すだけで連続してリサイズできる
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# =============================================================================
# コピーモード（テキスト選択・コピー）
# =============================================================================
# 使い方: prefix + [ でコピーモード開始 → v で選択開始 → y でコピー → q で終了
# マウスでドラッグ選択してもコピーできる

# コピーモードでVim風の操作を使う（h/j/k/lで移動、/で検索など）
setw -g mode-keys vi

# v で選択開始、y でmacOSクリップボードにコピー
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-pipe-and-cancel "pbcopy"

# =============================================================================
# その他の基本設定
# =============================================================================

# prefix + r でこの設定ファイルを再読み込みする（tmux再起動不要）
bind r source-file ~/.tmux.conf \; display "Reloaded!"

# Escキーの反応を速くする（Vimを使うときに遅延がなくなる）
set -sg escape-time 0

# ペイン内のプログラムがアクティブになっても通知しない（集中を妨げない）
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
setw -g monitor-activity off
set -g bell-action none

# スクロールバッファのサイズ（50000行分の出力を遡れる）
set -g history-limit 50000

# =============================================================================
# セッション管理（Claude Code並列実行の要）
# =============================================================================
# セッション = ウィンドウとペインをまとめたグループ。
# Claude Codeを複数同時に動かすときは、セッションごとに分けると管理しやすい。
# 例: claude-1（フロントエンド）、claude-2（バックエンド）、claude-3（テスト）

# prefix + C : Claude Code用セッションを新規作成する
# 自動でclaude-1, claude-2, ...と連番で名前がつく
bind C run-shell ' \
  n=1; \
  while tmux has-session -t "claude-$n" 2>/dev/null; do \
    n=$((n + 1)); \
  done; \
  tmux new-session -d -s "claude-$n" -c "#{pane_current_path}"; \
  tmux switch-client -t "claude-$n"; \
  tmux display-message "Created session: claude-$n"'

# prefix + s : セッション一覧をツリー表示して選択（tmuxデフォルト）
# prefix + ( : 前のセッションへ移動（tmuxデフォルト）
# prefix + ) : 次のセッションへ移動（tmuxデフォルト）

# prefix + S : セッション名を入力して直接切り替える
bind S command-prompt -p "Switch to session:" "switch-client -t '%%'"

# prefix + Tab : 直前にいたセッションに戻る（2つのセッション間を行き来するのに便利）
bind Tab switch-client -l

# prefix + $ : セッション名を変更する（tmuxデフォルト）

# =============================================================================
# レイアウトプリセット
# =============================================================================
# 新しいセッションを作ったらすぐにレイアウトを設定できる。
# ペインの分割と配置を一発で行う。
# 使い方: prefix を押してから Option+数字 を押す。
# ※ GhosttyでOptionキーをAlt(Meta)として送信する設定が必要（macos-option-as-alt）

# prefix + Option+1 : 2ペイン横並び ┃ メイン(左) + サブ(右)
bind M-1 run-shell ' \
  tmux split-window -h -c "#{pane_current_path}"; \
  tmux select-layout main-vertical; \
  tmux display-message "Layout: 2-pane horizontal"'

# prefix + Option+2 : 3ペイン ┃ メイン(左) + サブ2つ(右上下)
bind M-2 run-shell ' \
  tmux split-window -h -c "#{pane_current_path}"; \
  tmux split-window -v -c "#{pane_current_path}"; \
  tmux select-pane -t 1; \
  tmux display-message "Layout: 3-pane (main + 2 sub)"'

# prefix + Option+3 : 4ペイン均等タイル ┼ 田の字型に4分割
bind M-3 run-shell ' \
  tmux split-window -h -c "#{pane_current_path}"; \
  tmux split-window -v -c "#{pane_current_path}"; \
  tmux select-pane -t 1; \
  tmux split-window -v -c "#{pane_current_path}"; \
  tmux select-layout tiled; \
  tmux display-message "Layout: 4-pane tiled"'

# prefix + Option+4 : 既存ペインを全て横並び均等に配置し直す
bind M-4 select-layout even-horizontal \; display-message "Layout: even-horizontal"

# prefix + Option+5 : 既存ペインを全て縦並び均等に配置し直す
bind M-5 select-layout even-vertical \; display-message "Layout: even-vertical"

# prefix + E : ペインをタイル状に再整列する（ペインが増減した後の整理に便利）
bind E select-layout tiled \; display-message "Layout: tiled (re-arranged)"

# =============================================================================
# ステータスバー（画面上部の情報表示）
# =============================================================================
# GhosttyのRyuukoテーマと色を合わせている。
# カスタマイズする場合は以下のRyuukoカラーパレットを参照:
#   背景: #2c3941  前景: #ececec
#   赤: #865f5b  緑: #66907d  黄: #b1a990
#   青: #6a8e95  マゼンタ: #b18a73  シアン: #88b2ac
#   灰: #5d7079

# ステータスバーの背景色と文字色
set -g status-style "bg=#2c3941,fg=#ececec"

# 左側: 現在のセッション名を青背景で目立たせて表示
set -g status-left-length 40
set -g status-left "#[bg=#6a8e95,fg=#2c3941,bold] #S #[bg=#2c3941,fg=#6a8e95]"

# 右側: ペイン数(P:N) | カレントディレクトリ | 日時 を表示
set -g status-right-length 100
set -g status-right "#[fg=#88b2ac]P:#{window_panes} #[fg=#5d7079]| #[fg=#b1a990]#{=30:pane_current_path} #[fg=#5d7079]| #[fg=#66907d]%m/%d %H:%M"

# 中央のウィンドウリスト: アクティブなウィンドウは緑背景で強調表示
setw -g window-status-style "fg=#5d7079,bg=#2c3941"
setw -g window-status-format " #I:#W "
setw -g window-status-current-style "fg=#2c3941,bg=#66907d,bold"
setw -g window-status-current-format " #I:#W* "

# ペイン間の境界線の色（アクティブなペインは青で強調）
set -g pane-border-style "fg=#5d7079"
set -g pane-active-border-style "fg=#6a8e95"

# ペインのタイトルをボーダー上部に表示する
set -g pane-border-status top
set -g pane-border-format "#[fg=#5d7079] #{?pane_title,#{pane_title},─} "

# メッセージ表示の色（prefix + r でReloaded!が表示されるときなど）
set -g message-style "bg=#6a8e95,fg=#2c3941,bold"
set -g message-command-style "bg=#b18a73,fg=#2c3941"

# コピーモードの選択範囲のハイライト色
setw -g mode-style "bg=#6a8e95,fg=#2c3941"

# =============================================================================
# 便利機能
# =============================================================================

# prefix + y : 全ペイン同時入力モードのON/OFF
# ONにすると、キー入力がすべてのペインに同時に送られる。
# 複数のClaude Codeに同じコマンドを一斉に送りたいときに使う。
bind y setw synchronize-panes \; display-message "synchronize-panes: #{?pane_synchronized,ON,OFF}"

# prefix + g : ポップアップシェルを開く
# 今の作業を中断せずに、ちょっとしたコマンドを実行できる。Escで閉じる。
bind g display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# prefix + f : fzfでセッションを検索・選択して切り替える
# セッションが増えてきたときに便利。fzfが必要（brew install fzf）。
bind f display-popup -E -w 60% -h 60% \
  "tmux list-sessions -F '#{session_name}' | fzf --reverse --header='Select session' | xargs -I{} tmux switch-client -t {}"

# prefix + z : ペインをズーム（全画面表示/戻す）（tmuxデフォルト）
# Claude Codeの長い出力を見るときに一時的にペインを大きくすると便利。

# prefix + m : ペインをマークする（入れ替え準備）
# prefix + M : マークしたペインと今のペインの位置を入れ替える
# 使い方: まず入れ替えたいペインで m → 相手のペインに移動して M
bind m select-pane -m \; display-message "Pane marked"
bind M swap-pane \; display-message "Pane swapped"

# prefix + B : 今のペインを別ウィンドウに分離する
# ペインが増えすぎたとき、一部を別ウィンドウに切り出せる。
bind B break-pane -d \; display-message "Pane broken out to new window"

# prefix + @ : 別ウィンドウのペインを今のウィンドウに結合する
# 「ウィンドウ番号:ペイン番号」を入力する（例: 2:1）
bind @ command-prompt -p "Join pane from (window:pane):" "join-pane -s '%%'"

# prefix + N : セッション名を claude-N 形式にリネームする
# 数字を入力するだけで claude-1, claude-2 などに名前を変えられる。
bind N command-prompt -p "Rename session to claude-N (enter N):" "rename-session 'claude-%%'"

# prefix + c : 新しいウィンドウを作る（今いるディレクトリを引き継ぐ）
bind c new-window -c "#{pane_current_path}"

# =============================================================================
# デフォルト起動レイアウト（4ペイン）
# =============================================================================
# tmux初回起動時に4ペイン（田の字型）を自動作成する。
# ペイン1: claude  ペイン2: operation  ペイン3,4: 無名
# 初回起動時のみ実行（セッション・ウィンドウ・ペインがそれぞれ1つの場合）
if-shell '[ "$(tmux list-panes -t: | wc -l)" -eq 1 ] && [ "$(tmux list-windows | wc -l)" -eq 1 ] && [ "$(tmux list-sessions | wc -l)" -eq 1 ]' {
    split-window -h -c "#{pane_current_path}"
    split-window -v -c "#{pane_current_path}"
    select-pane -t 1
    split-window -v -c "#{pane_current_path}"
    select-layout tiled
    select-pane -t 1 -T "claude"
    select-pane -t 2 -T "operation"
    select-pane -t 1
}